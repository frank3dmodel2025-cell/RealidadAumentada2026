<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Visualizador AR - Colocación Manual</title>
    
    <!-- Google Model Viewer -->
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>
    
    <!-- Fuentes e Iconos -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root { --accent: #000; --bg: #f5f5f7; }
        
        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background-color: var(--bg); height: 100dvh; width: 100vw; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .app-container { background: #ffffff; width: 100%; height: 100%; display: flex; flex-direction: column; }
        
        model-viewer { width: 100%; height: 100%; --poster-color: transparent; }

        /* --- UI DE AR PERSONALIZADA --- */
        
        /* Contenedor que solo se muestra en modo AR */
        #ar-ui-overlay {
            display: none; /* Se activa vía JS al entrar en AR */
            position: absolute; inset: 0; pointer-events: none;
            z-index: 100;
        }

        /* 1. RETÍCULA (Guía central) */
        .reticle {
            position: absolute; top: 50%; left: 50%;
            width: 40px; height: 40px;
            transform: translate(-50%, -50%);
            border: 2px solid rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }
        .reticle::after {
            content: ''; position: absolute; top: 50%; left: 50%;
            width: 4px; height: 4px; background: white;
            transform: translate(-50%, -50%); border-radius: 50%;
        }

        /* 2. BOTÓN COLOCAR */
        .place-btn-container {
            position: absolute; bottom: 30px; left: 0; right: 0;
            display: flex; justify-content: center;
            pointer-events: auto; /* Habilitar clicks */
        }
        
        .btn-place {
            background: #000; color: white; border: none;
            padding: 12px 24px; border-radius: 30px;
            font-size: 1rem; font-weight: 700;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: flex; align-items: center; gap: 8px;
            opacity: 0.5; cursor: not-allowed; /* Desactivado hasta detectar suelo */
            transition: all 0.3s ease;
        }
        
        .btn-place.active { opacity: 1; cursor: pointer; transform: scale(1.05); background: #007AFF; }
        
        /* Loader simple */
        .loader { position: absolute; top: 20px; left: 20px; background: rgba(255,255,255,0.9); padding: 5px 10px; border-radius: 8px; font-size: 12px; font-weight: bold; pointer-events: none; }

        /* Estilos Desktop/Pre-AR */
        .desktop-info { padding: 20px; text-align: center; position: absolute; bottom: 0; width: 100%; background: white; border-top-left-radius: 20px; border-top-right-radius: 20px; box-shadow: 0 -10px 20px rgba(0,0,0,0.05); }
        .btn-start-ar { width: 90%; padding: 15px; background: black; color: white; border: none; border-radius: 12px; font-weight: bold; font-size: 1rem; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div class="app-container">
        
        <!-- VISOR 3D -->
        <!-- 
            CAMBIOS CLAVE PARA ESTABILIDAD:
            1. scale="0 0 0": El modelo empieza invisible/diminuto.
            2. ar-modes="webxr...": Prioriza WebXR para que funcione nuestra UI.
            3. interaction-prompt="none": Quitamos la mano de Google que confunde.
        -->
        <model-viewer 
            id="ar-viewer"
            src="assets/modelo.glb"
            poster="assets/poster.webp"
            alt="Modelo 3D"
            
            ar
            ar-modes="webxr scene-viewer quick-look"
            ar-scale="fixed"
            ar-placement="floor"
            
            camera-controls
            shadow-intensity="1"
            interaction-prompt="none" 
            scale="1 1 1"
        >
            
            <!-- SLOT PARA NUESTRA UI EN AR (Solo funciona en WebXR) -->
            <div slot="ar-overlay" id="ar-ui-overlay">
                <!-- La Retícula Central -->
                <div class="reticle" id="reticle"></div>
                
                <!-- El Botón de Acción -->
                <div class="place-btn-container">
                    <button class="btn-place" id="btn-place" onclick="placeObject()">
                        <span class="material-icons-round">vertical_align_bottom</span>
                        <span>Colocar objeto</span>
                    </button>
                </div>
            </div>

            <!-- Botón para iniciar AR (Standard) -->
            <button slot="ar-button" style="display:none;" id="native-ar-btn"></button>
            
            <div class="loader" id="loader">Cargando...</div>
        </model-viewer>

        <!-- PANEL INFERIOR (Solo visible antes de entrar en AR) -->
        <div class="desktop-info">
            <h3>Visualizador de Precisión</h3>
            <p style="font-size: 0.9rem; color: #666; margin-bottom: 20px;">
                Pulsa el botón, apunta al suelo hasta ver la retícula y fija el objeto.
            </p>
            <button class="btn-start-ar" onclick="startAR()">
                Ver en Realidad Aumentada
            </button>
        </div>

    </div>

    <script>
        const viewer = document.getElementById('ar-viewer');
        const arUi = document.getElementById('ar-ui-overlay');
        const btnPlace = document.getElementById('btn-place');
        const reticle = document.getElementById('reticle');
        const nativeArBtn = document.getElementById('native-ar-btn');
        const loader = document.getElementById('loader');

        let isPlaced = false;

        // Carga completada
        viewer.addEventListener('load', () => { 
            loader.style.display = 'none'; 
            console.log("Modelo cargado");
        });

        // Iniciar AR (Simula click en el botón nativo oculto)
        function startAR() {
            nativeArBtn.click();
        }

        // --- LÓGICA PRINCIPAL DE AR ---

        // Detectar entrada/salida de AR
        viewer.addEventListener('ar-status', (event) => {
            if (event.detail.status === 'session-started') {
                // Entró en AR: Mostrar nuestra UI
                arUi.style.display = 'block';
                // REINICIAR ESTADO: Hacer el modelo invisible al inicio
                viewer.scale = "0 0 0"; 
                isPlaced = false;
                
                // Resetear botón UI
                btnPlace.classList.remove('active');
                btnPlace.innerHTML = `<span class="material-icons-round">radar</span> <span>Detectando suelo...</span>`;
                reticle.style.display = 'block';

            } else if (event.detail.status === 'not-presenting') {
                // Salió de AR: Ocultar UI y restaurar escala para el visor 3D normal
                arUi.style.display = 'none';
                viewer.scale = "1 1 1";
            }
        });

        // Detectar si el rastreo de AR es estable (para habilitar el botón)
        // Usamos un intervalo simple para chequear si el visor está listo en WebXR
        // Nota: Model-viewer no expone evento "plane-detected" fácil, simularemos la disponibilidad
        setInterval(() => {
            if (viewer.arStatus === 'session-started' && !isPlaced) {
                // Si estamos en AR y aún no hemos colocado el objeto
                // Asumimos que si han pasado 1-2 segundos, el tracking está activo
                // (Para una detección real de planos se requiere acceso a hit-test results, 
                // pero model-viewer lo abstrae. Este es el mejor enfoque UX sin código nativo complejo).
                
                // Habilitar botón visualmente
                btnPlace.classList.add('active');
                btnPlace.innerHTML = `<span class="material-icons-round">vertical_align_bottom</span> <span>Colocar aquí</span>`;
            }
        }, 2000);

        // --- FUNCIÓN COLOCAR OBJETO ---
        function placeObject() {
            if (!btnPlace.classList.contains('active')) return;

            // 1. "Instanciar" el objeto (Hacerlo visible)
            // Model-viewer mueve el objeto internamente siguiendo el suelo (hit-test)
            // En el momento que cambiamos la escala a 1, aparecerá donde esté la retícula.
            viewer.scale = "1 1 1"; 

            // 2. Bloquear UI
            isPlaced = true;
            reticle.style.display = 'none'; // Ocultar guía
            btnPlace.style.display = 'none'; // Ocultar botón
            
            // 3. Feedback opcional (vibración)
            if (navigator.vibrate) navigator.vibrate(50);
        }

    </script>
</body>
</html>
