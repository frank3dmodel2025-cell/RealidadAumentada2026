<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR Tap to Place</title>
    
    <!-- Model Viewer 3.4.0 -->
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root { --accent: #000; --bg: #f5f5f7; }
        
        body { margin: 0; background-color: var(--bg); height: 100dvh; width: 100vw; overflow: hidden; font-family: 'Inter', sans-serif; }
        
        .app-container { width: 100%; height: 100%; position: relative; background: white; }

        /* EL VISOR */
        model-viewer { 
            width: 100%; height: 100%; 
            --poster-color: transparent;
            /* Ocultamos el botón de AR por defecto para usar el nuestro personalizado */
        }

        /* UI SOBREPUESTA (Panel Inferior) */
        .bottom-panel {
            position: absolute; bottom: 0; left: 0; width: 100%;
            padding: 20px 20px 40px 20px; box-sizing: border-box;
            background: linear-gradient(to top, white 80%, transparent);
            display: flex; flex-direction: column; align-items: center;
            z-index: 10;
            pointer-events: none; /* Dejar pasar toques al modelo si es necesario */
        }
        
        .bottom-content {
            pointer-events: auto; /* Reactivar toques para el botón */
            width: 100%; max-width: 400px;
            text-align: center;
        }

        h2 { margin: 0 0 5px 0; font-size: 1.2rem; }
        p { margin: 0 0 20px 0; color: #666; font-size: 0.9rem; }

        .btn-ar {
            background: #000; color: white; border: none;
            padding: 16px; border-radius: 50px;
            font-size: 1rem; font-weight: 700; width: 100%;
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
            display: flex; align-items: center; justify-content: center; gap: 8px;
            cursor: pointer; transition: transform 0.2s;
        }
        .btn-ar:active { transform: scale(0.95); }

        /* MENSAJES FLOTANTES EN AR (Truco CSS) */
        /* Usamos el slot ar-prompt para mostrar la instrucción DENTRO de la cámara */
        .ar-instruction {
            display: none; /* Se activa solo cuando model-viewer lo decide */
            background: rgba(0,0,0,0.6); color: white;
            padding: 10px 20px; border-radius: 20px;
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            text-align: center; font-weight: bold;
        }
    </style>
</head>
<body>

    <div class="app-container">
        
        <!-- 
            CONFIGURACIÓN CRÍTICA:
            1. ar-modes="webxr": Forzamos WebXR para evitar pantalla negra.
            2. ar-scale="fixed": Mantiene el tamaño real (evita zoom in/out accidental).
            3. interaction-prompt="none": Quitamos la mano por defecto en 3D para manejarla nosotros.
        -->
        <model-viewer 
            id="ar-viewer"
            src="assets/modelo.glb"
            poster="assets/poster.webp"
            alt="Modelo 3D"
            
            ar
            ar-modes="webxr scene-viewer"
            ar-placement="floor"
            ar-scale="fixed"
            
            camera-controls
            touch-action="pan-y"
            shadow-intensity="1"
            shadow-softness="0.5"
            exposure="1"
        >
            <!-- Slot personalizado para el mensaje dentro de AR -->
            <div slot="ar-prompt" class="ar-instruction">
                <span class="material-icons-round" style="font-size: 40px; display:block;">touch_app</span>
                TOCA LA PANTALLA<br>PARA COLOCAR
            </div>

            <!-- Botón de entrada (oculto, lo activamos con JS) -->
            <button slot="ar-button" id="ar-element-btn" style="display:none"></button>
        </model-viewer>

        <!-- Interfaz Fuera de AR -->
        <div class="bottom-panel">
            <div class="bottom-content">
                <h2>Visualizador AR</h2>
                <p>Apunta al suelo y toca para fijar el objeto.</p>
                <button class="btn-ar" onclick="startAR()">
                    <span class="material-icons-round">view_in_ar</span>
                    <span>Iniciar Experiencia</span>
                </button>
            </div>
        </div>

    </div>

    <script>
        const viewer = document.getElementById('ar-viewer');
        const arBtnInternal = document.getElementById('ar-element-btn');

        // Variables de estado
        let isAR = false;
        let isPlaced = false;

        // Función para activar el botón interno del model-viewer
        function startAR() {
            if (viewer.canActivateAR) {
                viewer.activateAR();
            } else {
                alert("Dispositivo no compatible con WebXR AR.");
            }
        }

        // 1. DETECTAR CUANDO ENTRAMOS EN AR
        viewer.addEventListener('ar-status', (event) => {
            if (event.detail.status === 'session-started') {
                isAR = true;
                isPlaced = false;
                
                // TRUCO: Hacemos el modelo invisible (o minúsculo) al inicio
                // para que no aparezca flotando de golpe.
                viewer.scale = '0 0 0'; 
                
                // Mostramos instrucción (El slot ar-prompt se encarga visualmente, 
                // pero aquí aseguramos la lógica).
                console.log("Sesión AR Iniciada. Esperando Tap...");
            } else if (event.detail.status === 'not-presenting') {
                isAR = false;
                // Restaurar escala para la vista 3D normal
                viewer.scale = '1 1 1'; 
            }
        });

        // 2. LÓGICA DE "TAP TO PLACE" (Tocar para colocar)
        // Model-viewer en WebXR lanza eventos de clic cuando tocas la pantalla en AR.
        viewer.addEventListener('click', (e) => {
            if (!isAR) return; // Si estamos en 3D normal, no hacer nada especial

            if (!isPlaced) {
                // PRIMER TAP: "Colocar" el modelo
                // Al tocar, el modelo recupera su tamaño. Model-viewer ya calculó la posición en el suelo.
                viewer.scale = '1 1 1'; 
                isPlaced = true;
                console.log("Modelo Colocado!");
            } else {
                // TAPS SIGUIENTES: (Opcional) Reposicionar o no hacer nada
                // Si quieres que se mueva a donde tocas de nuevo, model-viewer lo hace por defecto si arrastras.
            }
        });

    </script>
</body>
</html>
